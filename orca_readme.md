# ORCA自動計算システム - 完全ガイド

## 概要

このシステムは、XYZファイルをフォルダに入れるだけで自動的にORCA量子化学計算を実行する完全自動化パイプラインです。

### 主な機能

- ✅ **完全自動化**: XYZファイルを入れるだけで自動実行
- ✅ **リアルタイム監視**: プログラム実行中にファイルを追加しても自動検知
- ✅ **バックグラウンド実行**: PCの再起動まで動き続ける
- ✅ **並列処理**: 複数の計算を同時実行（設定可能）
- ✅ **自動エラー処理**: エラー発生時の自動リトライ
- ✅ **結果自動整理**: 成功/失敗別に結果を整理
- ✅ **エネルギープロット自動生成**: 収束グラフを自動作成

## インストール方法

### 1. 必要なもの

- Python 3.7以上
- ORCA（インストール済み）

### 2. セットアップ

```bash
# 依存パッケージのインストール
pip install -r requirements.txt

# セットアップスクリプト実行
python setup.py
```

セットアップ時にORCAの実行ファイルパスを入力してください。

### 3. ディレクトリ構成

セットアップにより以下のディレクトリが自動作成されます：

```
orca_pipeline/
├── folders/
│   ├── input/          # ← ここにXYZファイルを入れる
│   ├── waiting/        # 処理待ちファイル（自動管理）
│   ├── working/        # 計算実行中（自動管理）
│   └── products/       # 結果出力先
│       ├── success/    # 成功した計算
│       └── failed/     # 失敗した計算
├── logs/               # ログファイル
└── config.txt          # 設定ファイル
```

## 使い方

### 基本的な使い方

1. **プログラムを起動**

```bash
python main.py
```

2. **XYZファイルを投入**

`folders/input/` フォルダにXYZファイルをコピーまたは移動します。

3. **自動実行**

ファイルが自動検知され、ORCA計算が開始されます。

4. **結果確認**

`folders/products/success/分子名/` に結果が保存されます。

### バックグラウンド実行

#### Linux / Mac

```bash
# バックグラウンドで起動
nohup python main.py > pipeline.log 2>&1 &

# プロセス確認
ps aux | grep main.py

# 停止
pkill -f main.py
```

#### Windows

```bash
# バックグラウンドで起動
pythonw main.py

# タスクマネージャーで確認・停止
```

### XYZファイル形式

```
原子数
コメント行（分子名など）
元素記号  X座標  Y座標  Z座標
元素記号  X座標  Y座標  Z座標
...
```

**例（水分子）:**

```
3
Water molecule
O     0.00000000    0.00000000    0.11779600
H     0.00000000    0.75545400   -0.47118400
H     0.00000000   -0.75545400   -0.47118400
```

**対応フォーマット:**
- タブ区切り・スペース区切り両対応
- 小文字の元素記号も自動認識
- Windows改行コード（CRLF）対応

## 設定ファイル（config.txt）

### 主要設定項目

```ini
[orca]
orca_path = /path/to/orca        # ORCAの実行ファイルパス
method = B3LYP                    # DFT法
basis = def2-SVP                  # 基底関数系
nprocs = 4                        # 使用コア数
maxcore_mb = 2000                 # メモリ（MB/コア）

[execution]
max_parallel_jobs = 5             # 同時実行数
max_retries = 2                   # リトライ回数
```

## 自動生成されるORCA入力ファイル例

### 最適化計算（OPT）

XYZファイル `ethanol.xyz` から自動生成される入力ファイル：

```
# ORCA input file for ethanol
# Generated by automated pipeline

%pal nprocs 4 end
%maxcore 2000

%output
  Print[P_Basis] 2
  Print[P_MOs] 1
end

! B3LYP def2-SVP OPT TightSCF

* xyz 0 1
  C    1.18500000   -0.00400000    0.00000000
  C   -0.30900000    0.22600000    0.00000000
  H    1.41300000   -1.07500000    0.00000000
  H    1.62600000    0.46000000    0.88900000
  H    1.62600000    0.46000000   -0.88900000
  O   -1.01000000   -1.02100000    0.00000000
  H   -0.55100000    0.77600000   -0.91800000
  H   -0.55100000    0.77600000    0.91800000
  H   -1.95300000   -0.83900000    0.00000000
*
```

### 振動数計算（FREQ）

最適化成功後、自動的に振動数計算用の入力ファイルも生成されます：

```
# ORCA input file for ethanol_freq
# Generated by automated pipeline

%pal nprocs 4 end
%maxcore 2000

%output
  Print[P_Basis] 2
  Print[P_MOs] 1
end

! B3LYP def2-SVP FREQ TightSCF

* xyz 0 1
  C    1.18234567   -0.00312345    0.00000000
  C   -0.31123456    0.22712345    0.00000000
  ...（最適化後の座標）
*
```

## 動作確認ポイント

### ✅ 起動時の既存ファイル読み込み

プログラム起動時、`folders/input/` に既にあるXYZファイルは自動的に処理されます。

```
INFO - Found 3 existing XYZ files to process
INFO - Processing existing file: molecule1.xyz
INFO - Processing existing file: molecule2.xyz
INFO - Processing existing file: molecule3.xyz
```

### ✅ 実行中のファイル追加検知

プログラム実行中に新しいXYZファイルを `folders/input/` に追加すると、即座に検知して処理が開始されます。

```
INFO - Detected new XYZ file: new_molecule.xyz
INFO - Created job new_molecule_opt_1730000000 for new_molecule
```

### ✅ バックグラウンド実行

- Linuxの場合: `nohup` コマンドでターミナルを閉じても動作継続
- Windowsの場合: `pythonw` でウィンドウなしで実行
- デーモンスレッドにより安定動作

## トラブルシューティング

### Q: ファイルが処理されない

1. `logs/` フォルダ内のログファイルを確認
2. XYZファイルの形式が正しいか確認
3. `config.txt` のorca_pathが正しいか確認

### Q: 計算が失敗する

- `folders/products/failed/分子名/error.txt` でエラー内容確認
- 自動リトライ機能により、一時的なエラーは自動復旧

### Q: プログラムが停止しない

```bash
# Linux/Mac
ps aux | grep main.py
kill [PID]

# Windows
タスクマネージャーでpython.exeを終了
```

## ログ確認

ログファイルは `logs/` フォルダに保存されます：

```bash
# 最新のログを確認
tail -f logs/pipeline_*.log

# エラーだけを表示
grep ERROR logs/pipeline_*.log
```

## 高度な使用例

### 溶媒効果を含む計算

`config.txt` を編集：

```ini
[orca]
solvent = water
solvent_model = CPCM
```

### メール通知機能

Gmail経由で計算完了通知を受け取れます：

```ini
[gmail]
enabled = true
sender_email = your_email@gmail.com
sender_password = app_specific_password
recipient_email = notify@example.com
```

## システムの特長

### 完全自動化ワークフロー

1. XYZ検知 → INP自動生成
2. ORCA実行 → 出力解析
3. エネルギープロット生成
4. 成功時は自動的に振動数計算へ
5. 結果自動整理

### エラー処理

- **リカバリー可能エラー**: 自動リトライ（SCF収束失敗など）
- **致命的エラー**: 失敗フォルダに移動して次の計算へ
- **クラッシュ回復**: プログラム再起動時に未完了ジョブを自動検知

### 並列処理

設定した数まで同時に計算を実行し、効率的にCPUを使用します。

## サポート

問題が発生した場合：
1. ログファイル確認
2. エラーメッセージを確認
3. XYZファイル形式の確認
4. ORCA本体の動作確認

## ライセンス

このプログラムは研究・教育目的で自由に使用できます。
